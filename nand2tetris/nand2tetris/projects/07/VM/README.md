# VM

## 関数呼び出しコマンド

VM言語は次の3つの関数に関するコマンドを持つ。

- function f n
  - n個のローカル変数を持つf という名前の関数を定義する
- call f n
  - f という関数を呼ぶ。ここで、m個の引数は、呼び出し側によってスタックに プッシュ済みであるとする
- return
  - 呼び出し元へリターンする

### グローバルスタック

- VMで使用するメモリは、グローバルスタックに保持される形で実装される
- 関数が呼ばれるごとに、新しいブロックがグローバルスタックに追加される
- ブロックは
  - 「引数（argument）」
  - 「ポインタ（pointer）」
  - 「ローカル変数（local variable）」
  - 「ワーキングスタック（working stack）」
  - から構成される
- 引数は、関数を呼び出された側のために、呼び出す側によって設定される
- ポインタは、関数を呼び出す側の状態を格納するためにVM実装によって使用される
- ローカル変数は呼び出された側のためのローカル変数であり（0に初期化される）、ワーキングスタックも呼び出された側のために使用される

VM実装によって生成される（擬似）コード call f n （n個の引数がスタック にプッシュされた後に 関数fが呼ばれる） 

# push return-address #（ 以下のラベル宣言を用いる）
# push LCL # 関数の呼び出し側のLCLを格納する
# push ARG # 関数の呼び出し側のARGを格納する
# push THIS # 関数の呼び出し側のTHISを格納する
# push THAT # 関数の呼び出し側のTHATを格納する
# ARG = SP-n-5 # ARGを別の場所に移す（n＝引数の数）
# LCL = SP # LCLを別の場所に移す
# goto f # 制御を移す
# (return-address)  # リターンアドレスのためのラベルを宣言する

<a>test</a>
